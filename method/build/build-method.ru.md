# Методология сборки БЭМ-проекта

Организация файловой системы, обусловленная использованием компонентного подхода, определяет особенности сборки БЭМ-проекта.

Основная задача сборки — из множества [файлов реализаций](../filesystem/filesystem.ru.md#Реализация-блока-разделяется-на-отдельные-файлы) собрать в проект только нужные. При этом важно учитывать порядок подключения файлов в сборку.

Типовой БЭМ-проект предполагает разделение интерфейса на независимые [блоки](../definitions/definitions.ru.md#Блок). Блоки, в свою очередь, могут быть реализованы в одной или нескольких [технологиях](../definitions/definitions.ru.md#Технология-реализации). Технологии реализации находятся в отдельных файлах. [Реализация](../definitions/definitions.ru.md#Реализация-блока) каждого блока может быть дополнительно разделена по [уровням переопределения](../definitions/definitions.ru.md#Уровень-переопределения).

```
blocks/                 # Уровень проекта
    input/              # Директория блока `input`
        input.css       # Реализация блока `input` в технологии CSS
        input.js        # Реализация блока `input` в технологии JavaScript
    icon/
        icon.css
library/                # Уровень библиотеки
    input/
    button/
```

>Подробно о целях разделения блоков на отдельные файлы читайте в документе [Организация файловой системы БЭМ-проекта](../filesystem/filesystem.ru.md).

Для того, чтобы в результат сборки попали только нужные БЭМ-сущности в строго определенном порядке, при сборке БЭМ-проекта используются:

* [Декларация](#Декларация)
* [Зависимости](#Зависимости)
* [Уровни переопределения](#Уровни-переопределения)

<a name="bundle"></a>
Результатом сборки является **бандл** — это совокупность необходимых реализаций [БЭМ-сущностей](../definitions/definitions.ru.md#БЭМ-сущность), собранных в определенном порядке, для формирования страницы сайта, любого ее фрагмента или сразу нескольких страниц. Например, если у всех страниц сайта одинаковая шапка и подвал, можно выделить их реализацию в отдельный бандл, собрать один раз и повторно использовать при сборке.

Бандлы собираются на основе [деклараций](#Декларация), поэтому и управление бандлами происходит с помощью деклараций.

В файловой системе бандл представляет собой отдельную директорию.

```
blocks/         # Директория, содержащая блоки
bundles/        # Директория, содержащая бандлы
    bundle-1/   # Директория бандла `bundle-1`
    bundle-2/   # Директория бандла `bundle-2`
```

В типовом БЭМ-проекте директория бандла до начала сборки содержит файл с описанием страницы (`<bundle>.bemjson.js`). На основании этого файла строится декларация страницы. Декларация и конфигурация сборки определяют, какие собранные файлы технологий (результаты выполнения сборки) попадут в директорию бандла.

Пример файловой системы типового БЭМ-проекта до выполнения сборки:

```
blocks/         # Директория, содержащая блоки
bundles/        # Директория, содержащая бандлы
    bundle-1/   # Директория бандла `bundle-1`
        bundle-1.bemjson.js  # Описание бандла `bundle-1` в формате BEMJSON
    bundle-2/   # Директория бандла `bundle-2`
        bundle-2.bemjson.js  # Описание бандла `bundle-2` в формате BEMJSON
```

Пример файловой системы типового БЭМ-проекта после выполнения сборки:

```
blocks/         # Директория, содержащая блоки
bundles/        # Директория, содержащая бандлы
    bundle-1/   # Директория бандла `bundle-1`
        bundle-1.bemjson.js  # Описание бандла `bundle-1` в формате BEMJSON
        bundle-1.html     # Собранный HTML-файл для бандла `bundle-1`
        bundle-1.css      # Собранный CSS-файл для бандла `bundle-1`
        bundle-1.js       # Собранный JavaScript-файл для бандла `bundle-1`
```

>Страница — это частный случай бандла. В документе рассмотрена сборка бандла на примере страницы.

## Основные понятия сборки БЭМ-проекта

[Зависимости](#Зависимости), [уровни переопределения](#Уровни-переопределения) и наличие [декларации](#Декларация) позволяют контролировать сборку:

* подключать в проект только нужные БЭМ-сущности и технологии;
* переопределять БЭМ-сущности без дублирования кода;
* выделять повторно используемые части проекта в отдельные бандлы.

Однако сборка БЭМ-проекта может осуществляться и без использования зависимостей, уровней переопределения и декларации. Применение описанных ниже понятий опционально. В таком случае в проект будут собраны все БЭМ-сущности с файловой системы, что значительно увеличит кодовую базу собранного бандла.

### Декларация

Это упорядоченное множество [БЭМ-сущностей](../definitions/definitions.ru.md#БЭМ-сущность), необходимых для сборки [бандла](#bundle). Декларация определяет что и в каком порядке подключать в сборку. Благодаря декларации в бандл попадают только нужные БЭМ-сущности.

![Декларация](https://img-fotki.yandex.ru/get/15577/246231603.1/0_16353e_4f60f18f_orig)

Рассмотрим пример использования декларации:

В проекте на отдельный уровень переопределения подключена библиотека, из которой на странице используются только несколько блоков. Нет необходимости включать все блоки библиотеки в сборку страницы. Достаточно указать в декларации нужный набор блоков и подключать в сборку только их.

Таким образом, декларация позволяет отфильтровать необходимые для сборки бандла файлы реализаций с подключенных в сборку уровней переопределения.

Файл декларации находится в директории бандла:

```
blocks/
    input/
    button/
    checkbox/
bundles/
    bundle/
        bundle.bemdecl.js # Упорядоченное множество БЭМ-сущностей для сборки бандла
```

>В БЭМ-платформе упорядоченное множество БЭМ-сущностей описывается в формате BEMDECL, например:
```
exports.blocks = [
    { name: 'input' },
    { name: 'button' },
    { name: 'checkbox' }
];
```

#### Способы получения декларации

Декларация может формироваться вручную (для этого нужно перечислить БЭМ-сущности, необходимые для построения страницы) или строиться автоматически:

* [по описанию страницы](#Создание-декларации-по-описанию-страницы)
* [с помощью интроспекции файловой системы](#Создание-декларации-с-помощью-интроспекции-файловой-системы)

##### Создание декларации по описанию страницы

В БЭМ-методологии существует понятие [БЭМ-дерева](../definitions/definitions.ru.md#БЭМ-дерево) — описания структуры страницы в терминах блоков, элементов и модификаторов. БЭМ-дерево содержит имена [БЭМ-сущностей](../definitions/definitions.ru.md#БЭМ-сущность), которые используются на странице. Оно может быть создано вручную (BEMJSON) или построено автоматически, например, на основании HTML-файла.

При сборке страницы декларация формируется автоматически на основании данных из БЭМ-дерева: все сущности, используемые в БЭМ-дереве, попадают в декларацию в требуемом порядке.

Один из инструментов, позволяющих получить БЭМ-дерево из HTML-структуры страницы — [html2bemjson](https://github.com/bem-incubator/html2bemjson).

![Способ создания декларации](https://img-fotki.yandex.ru/get/6114/246231603.1/0_162b0c_f5211dc6_orig)

Пример показывает, как в результате анализа HTML-классов, написанных в соответствии с [соглашением по именованию БЭМ](../naming/naming-convention.ru.md), создается декларация.

>Пример проекта, в котором формируется отдельная декларация для каждой страницы — [Создаем свой проект на БЭМ](https://ru.bem.info/tutorials/start-with-project-stub/).

##### Создание декларации с помощью интроспекции файловой системы

При сборке в декларацию автоматически попадают все БЭМ-сущности, находящиеся в файловой системе проекта на уровнях переопределения, указанных в конфигурационном файле сборки.

![Способ создания декларации](https://img-fotki.yandex.ru/get/4510/246231603.1/0_162b0d_d4139277_orig)

>В [bem-components](https://ru.bem.info/libs/bem-components/) такой способ создания декларации используется для поставки библиотеки в виде [Dist](https://ru.bem.info/libs/bem-components/current/#Варианты-поставки-библиотеки).

#### Способы управления декларациями

Декларации, на основании которых строятся бандлы, можно по-разному совмещать, повторно использовать, выделять общие части или различия. Таким образом можно управлять бандлами: собирать все страницы в один бандл, догружать необходимые части страницы по требованию, повторно использовать уже собранный бандл на разных страницах и так далее.

Рассмотрим возможные действия с декларациями:

* [сложение](#Объединение-нескольких-деклараций-в-одну) — объединение нескольких деклараций в одну;
* [вычитание](#Получение-разницы-между-декларациями) — получение разницы между декларациями;
* [пересечение](#Получение-новой-декларации-на-основе-пересечения-нескольких-других) — получение новой декларации на основе пересечения нескольких других.

##### Объединение нескольких деклараций в одну

Объединяет все БЭМ-сущности суммируемых деклараций в одну. Один из способов применения — формирование [merged-бандла](https://github.com/enb-bem/enb-bem-techs/blob/master/docs/build-merged-bundle.md). В результате для объединенной декларации генерируются общие файлы технологий (например, один CSS- и JavaScript-файл).

<a name="получение-разницы-между-декларациями"></a>
##### Получение разницы между декларациями

Один из способов применения — формирование бандла, который догружается на страницу по требованию (например, в ответ на действие пользователя).

Например, на странице используется виртуальная клавиатура, которая становится доступна пользователю только в ответ на определенное действие. Нет необходимости включать этот блок в сборку бандла для всей страницы, так как это увеличит время при загрузке. Частично кнопки клавиатуры могут быть уже реализованы на странице для других целей. Возможность вычитать декларации позволяет создать отдельный бандл для недостающей реализации виртуальной клавиатуры и подключать его только по требованию.

##### Получение новой декларации на основе пересечения нескольких других

Применяется для создания декларации, описывающей общие части разных страниц проекта. Это позволяет сформировать бандл отдельно для общей части и подключать его при сборке один раз ко всем страницам.

Например, такое разделение эффективно, если в проекте на всех страницах используется `шапка` и `подвал`. Общая часть страниц описывается в отдельной декларации. При сборке бандл каждой страницы собирается на основании двух деклараций: общей (содержащей шапку и подвал) и уникальной.

### Зависимости

Для корректной работы всех компонентов страницы при сборке необходимо учитывать зависимости между различными БЭМ-сущностями.

Зависимости можно указать различными способами:

* В файлах реализации блока.<br>
```
blocks/
    input/
        input.css       # Зависимости в CSS можно определять по правилам `@import`.
        input.js        # Файл `js`, который декларирует зависимости с помощью модульной системы
    button/
        button.css
        button.js
    icon/
        icon.css
```

* В отдельном файле блока.<br>
```
blocks/
    input/
        input.css
        input.js
        input.deps.js   # Файл с зависимостями блока `input`
    button/
        button.css
        button.js
    icon/
        icon.css
```

На основе информации о зависимостях инструмент сборки определяет, какие дополнительные сущности или технологии необходимы для реализации блока, и включает их при сборке в требуемом порядке в бандл.

>В БЭМ-платформе для указания зависимостей используется технология [DEPS](https://ru.bem.info/technology/deps/).

### Уровни переопределения

Исходные реализации БЭМ-сущностей разложены в проекте по [уровням переопределения](../definitions/definitions.ru.md#Уровень-переопределения), поэтому при сборке необходимо указать уровни, с которых файлы технологий будут попадать в сборку.

При сборке важно соблюдать порядок подключения уровней для корректного [переопределения](../definitions/definitions.ru.md#Переопределение-блока) БЭМ-сущностей проекта. Порядок подключения определяется в конфигурационном файле сборщика.

На схеме показан принцип использования уровней переопределения при сборке: с уровня `common` подключаются общие компоненты для всех платформ, а с уровней `desktop` и `touch` — платформо-специфичные компоненты.

![Уровни переопределения](https://img-fotki.yandex.ru/get/15587/246231603.1/0_162b0f_98525a17_orig)

Подробно об использовании уровней читайте в примерах:

* [Переопределение блоков библиотеки](../filesystem/filesystem.ru.md#Подключение-библиотеки).
* [Разделение проекта на платформы](../filesystem/filesystem.ru.md#Разделение-проекта-на-платформы).

## Инструменты для сборки

Выбор инструмента для сборки зависит от сложности БЭМ-проекта, наличия в нем уровней переопределения и использования зависимостей.

БЭМ-методология не ограничивает выбор инструмента — можно использовать любые сборщики (например, Gulp, Grant, Brunch, Broccoli), отвечающие требованиям вашего проекта.

>Пример сборки БЭМ-проекта с помощью Gulp — [Декларативный JavaScript по БЭМ](https://ru.bem.info/events/beminar-july-2015/).

В БЭМ-платформе реализованы два инструмента, которые подходят для сборки БЭМ-проектов любой сложности:

* [ENB](https://ru.bem.info/tools/bem/enb-bem/)
* [bem-tools](https://ru.bem.info/tools/bem/bem-tools/)

>Пример сборки БЭМ-проекта с помощью [ENB](https://ru.bem.info/tools/bem/enb-bem/) или [bem-tools](https://ru.bem.info/tools/bem/bem-tools/) — [Создаем свой проект на БЭМ](https://ru.bem.info/tutorials/start-with-project-stub/).
